schemaVersion: 2.2.0
metadata:
  name: simple-rest-go
  version: 1.0.0
  description: Go application built using a Devfile

components:
  - name: go-runtime
    container:
      image: golang:1.23-alpine
      command: ["/bin/sh"]
      args: ["-c", "while true; do sleep 10000; done"]
      mountSources: true
      workingDir: /app
      memoryLimit: 512Mi
      cpuLimit: 500m

  - name: ubi-runtime
    container:
      image: registry.access.redhat.com/ubi9/ubi-micro:latest
      mountSources: true
      workingDir: /app
      memoryLimit: 256Mi
      cpuLimit: 300m

commands:
  - id: install-deps
    exec:
      component: go-runtime
      commandLine: |
        if [ -f go.sum ]; then go mod download; else go mod tidy; fi
      workingDir: /app
      group:
        kind: build
        isDefault: true

  - id: build-app
    exec:
      component: go-runtime
      commandLine: |
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo -o api .
      workingDir: /app
      group:
        kind: build
        isDefault: true

  - id: run-app
    exec:
      component: go-runtime
      commandLine: ./api
      workingDir: /app
      group:
        kind: run
        isDefault: true

events:
  postStart:
    - install-deps
    - build-app
